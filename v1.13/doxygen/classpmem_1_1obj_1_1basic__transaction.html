<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PMDK C++ bindings: pmem::obj::basic_transaction Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PMDK C++ bindings
   &#160;<span id="projectnumber">1.13.0-git23.gf49772ac</span>
   </div>
   <div id="projectbrief">This is the C++ bindings documentation for PMDK&#39;s libpmemobj.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacepmem.html">pmem</a></li><li class="navelem"><a class="el" href="namespacepmem_1_1obj.html">obj</a></li><li class="navelem"><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html">basic_transaction</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="classpmem_1_1obj_1_1basic__transaction-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">pmem::obj::basic_transaction Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>C++ transaction handler class.  
 <a href="classpmem_1_1obj_1_1basic__transaction.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="transaction_8hpp_source.html">libpmemobj++/transaction.hpp</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for pmem::obj::basic_transaction:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classpmem_1_1obj_1_1basic__transaction.png" usemap="#pmem::obj::basic_5Ftransaction_map" alt=""/>
  <map id="pmem::obj::basic_5Ftransaction_map" name="pmem::obj::basic_5Ftransaction_map">
<area href="classpmem_1_1detail_1_1transaction__base.html" alt="pmem::detail::transaction_base&lt; false &gt;" shape="rect" coords="0,0,233,24"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-types"></a>
Public Types</h2></td></tr>
<tr class="memitem:ad86b8b9def7073307927ba6e41d0fbf5"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">manual</a> = typename <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">detail::transaction_base</a>&lt; false &gt;::<a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">manual</a></td></tr>
<tr class="memdesc:ad86b8b9def7073307927ba6e41d0fbf5"><td class="mdescLeft">&#160;</td><td class="mdescRight">C++ manual scope transaction class.  <a href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">More...</a><br /></td></tr>
<tr class="separator:ad86b8b9def7073307927ba6e41d0fbf5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ffae81b74ffe313eb2deb16573d70e1"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">automatic</a> = typename <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">detail::transaction_base</a>&lt; false &gt;::<a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">automatic</a></td></tr>
<tr class="memdesc:a8ffae81b74ffe313eb2deb16573d70e1"><td class="mdescLeft">&#160;</td><td class="mdescRight">C++ automatic scope transaction class.  <a href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">More...</a><br /></td></tr>
<tr class="separator:a8ffae81b74ffe313eb2deb16573d70e1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_types_classpmem_1_1detail_1_1transaction__base"><td colspan="2" onclick="javascript:toggleInherit('pub_types_classpmem_1_1detail_1_1transaction__base')"><img src="closed.png" alt="-"/>&#160;Public Types inherited from <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">pmem::detail::transaction_base&lt; false &gt;</a></td></tr>
<tr class="memitem:a1e4345317108f070b1917aeb58d4c51d inherit pub_types_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">enum class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#a1e4345317108f070b1917aeb58d4c51d">stage</a> </td></tr>
<tr class="memdesc:a1e4345317108f070b1917aeb58d4c51d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Possible stages of a transaction.  <a href="classpmem_1_1detail_1_1transaction__base.html#a1e4345317108f070b1917aeb58d4c51d">More...</a><br /></td></tr>
<tr class="separator:a1e4345317108f070b1917aeb58d4c51d inherit pub_types_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a3fd9d0f0d14eaa20e8c883f76a8878ab"><td class="memItemLeft" align="right" valign="top"><a id="a3fd9d0f0d14eaa20e8c883f76a8878ab"></a>
&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a3fd9d0f0d14eaa20e8c883f76a8878ab">~basic_transaction</a> () noexcept=delete</td></tr>
<tr class="memdesc:a3fd9d0f0d14eaa20e8c883f76a8878ab"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default destructor. <br /></td></tr>
<tr class="separator:a3fd9d0f0d14eaa20e8c883f76a8878ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_classpmem_1_1detail_1_1transaction__base"><td colspan="2" onclick="javascript:toggleInherit('pub_methods_classpmem_1_1detail_1_1transaction__base')"><img src="closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">pmem::detail::transaction_base&lt; false &gt;</a></td></tr>
<tr class="memitem:a4aae50c8d4260ae810319d7390cc57c4 inherit pub_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#a4aae50c8d4260ae810319d7390cc57c4">~transaction_base</a> () noexcept=delete</td></tr>
<tr class="memdesc:a4aae50c8d4260ae810319d7390cc57c4 inherit pub_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default destructor.  <a href="classpmem_1_1detail_1_1transaction__base.html#a4aae50c8d4260ae810319d7390cc57c4">More...</a><br /></td></tr>
<tr class="separator:a4aae50c8d4260ae810319d7390cc57c4 inherit pub_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a9564707de1779ca1bce7041fb7c9855c"><td class="memTemplParams" colspan="2">template&lt;typename... Locks&gt; </td></tr>
<tr class="memitem:a9564707de1779ca1bce7041fb7c9855c"><td class="memTemplItemLeft" align="right" valign="top">static void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a9564707de1779ca1bce7041fb7c9855c">run</a> (<a class="el" href="classpmem_1_1obj_1_1pool__base.html">obj::pool_base</a> &amp;<a class="el" href="classpmem_1_1obj_1_1pool.html">pool</a>, std::function&lt; void()&gt; tx, Locks &amp;... locks)</td></tr>
<tr class="memdesc:a9564707de1779ca1bce7041fb7c9855c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute a closure-like transaction and lock <code>locks</code>.  <a href="classpmem_1_1obj_1_1basic__transaction.html#a9564707de1779ca1bce7041fb7c9855c">More...</a><br /></td></tr>
<tr class="separator:a9564707de1779ca1bce7041fb7c9855c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td colspan="2" onclick="javascript:toggleInherit('pub_static_methods_classpmem_1_1detail_1_1transaction__base')"><img src="closed.png" alt="-"/>&#160;Static Public Member Functions inherited from <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">pmem::detail::transaction_base&lt; false &gt;</a></td></tr>
<tr class="memitem:afc3bcf42e4b82b444a2e3a5a21d4ef8c inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#afc3bcf42e4b82b444a2e3a5a21d4ef8c">abort</a> (int err)</td></tr>
<tr class="memdesc:afc3bcf42e4b82b444a2e3a5a21d4ef8c inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Manually abort the current transaction.  <a href="classpmem_1_1detail_1_1transaction__base.html#afc3bcf42e4b82b444a2e3a5a21d4ef8c">More...</a><br /></td></tr>
<tr class="separator:afc3bcf42e4b82b444a2e3a5a21d4ef8c inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16c0d86f943d6727e1caa7573cc83edb inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#a16c0d86f943d6727e1caa7573cc83edb">commit</a> ()</td></tr>
<tr class="memdesc:a16c0d86f943d6727e1caa7573cc83edb inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Manually commit a transaction.  <a href="classpmem_1_1detail_1_1transaction__base.html#a16c0d86f943d6727e1caa7573cc83edb">More...</a><br /></td></tr>
<tr class="separator:a16c0d86f943d6727e1caa7573cc83edb inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ada1950241b0a503c2ce0628ec03e99f0 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#ada1950241b0a503c2ce0628ec03e99f0">run</a> (<a class="el" href="classpmem_1_1obj_1_1pool__base.html">obj::pool_base</a> &amp;pool, std::function&lt; void()&gt; tx, Locks &amp;... locks)</td></tr>
<tr class="memdesc:ada1950241b0a503c2ce0628ec03e99f0 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute a closure-like transaction and lock <code>locks</code>.  <a href="classpmem_1_1detail_1_1transaction__base.html#ada1950241b0a503c2ce0628ec03e99f0">More...</a><br /></td></tr>
<tr class="separator:ada1950241b0a503c2ce0628ec03e99f0 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63dffc5d7316f67f900e4cf8de8b6422 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#a63dffc5d7316f67f900e4cf8de8b6422">snapshot</a> (const T *addr, size_t num=1)</td></tr>
<tr class="memdesc:a63dffc5d7316f67f900e4cf8de8b6422 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Takes a “snapshot” of given elements of type T number (1 by default), located at the given address ptr in the virtual memory space and saves it to the undo log.  <a href="classpmem_1_1detail_1_1transaction__base.html#a63dffc5d7316f67f900e4cf8de8b6422">More...</a><br /></td></tr>
<tr class="separator:a63dffc5d7316f67f900e4cf8de8b6422 inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abd22aa1c4862fc4e1974e39fca7f3dfa inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classpmem_1_1detail_1_1transaction__base.html#abd22aa1c4862fc4e1974e39fca7f3dfa">register_callback</a> (<a class="el" href="classpmem_1_1detail_1_1transaction__base.html#a1e4345317108f070b1917aeb58d4c51d">stage</a> stg, std::function&lt; void()&gt; cb)</td></tr>
<tr class="memdesc:abd22aa1c4862fc4e1974e39fca7f3dfa inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="mdescLeft">&#160;</td><td class="mdescRight">Registers callback to be called on specified stage for the transaction.  <a href="classpmem_1_1detail_1_1transaction__base.html#abd22aa1c4862fc4e1974e39fca7f3dfa">More...</a><br /></td></tr>
<tr class="separator:abd22aa1c4862fc4e1974e39fca7f3dfa inherit pub_static_methods_classpmem_1_1detail_1_1transaction__base"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>C++ transaction handler class. </p>
<p>This class should be used with care. It's recommended to use <a class="el" href="classpmem_1_1obj_1_1flat__transaction.html" title="C++ flat transaction handler class.">pmem::obj::flat_transaction</a> instead.</p>
<p>This class is the pmemobj transaction handler. Scoped transactions are handled through two internal classes: <a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">manual</a> and <a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">automatic</a>.</p><ul>
<li><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">manual</a> transactions need to be committed manually, otherwise they will be aborted on object destruction.<br  />
</li>
<li><a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">automatic</a> transactions are only available in C++17. They handle transaction commit/abort automatically.</li>
</ul>
<p>This class also exposes a closure-like transaction API, which is the preferred way of handling transactions.</p>
<p>This API should NOT be mixed with C transactions API. One issue is that C++ callbacks registered using <a class="el" href="classpmem_1_1detail_1_1transaction__base.html#abd22aa1c4862fc4e1974e39fca7f3dfa" title="Registers callback to be called on specified stage for the transaction.">transaction::register_callback()</a> would not be called if C++ transaction is created inside C transaction. The same is true if user calls pmemobj_tx_set_user_data() inside a C++ transaction.</p>
<p>The typical usage example would be: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="make__persistent_8hpp.html">libpmemobj++/make_persistent.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mutex_8hpp.html">libpmemobj++/mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="persistent__ptr_8hpp.html">libpmemobj++/persistent_ptr.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pext_8hpp.html">libpmemobj++/pext.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pool_8hpp.html">libpmemobj++/pool.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="shared__mutex_8hpp.html">libpmemobj++/shared_mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="transaction_8hpp.html">libpmemobj++/transaction.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacepmem_1_1obj.html">pmem::obj</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">general_tx_example()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* pool root structure */</span></div>
<div class="line">    <span class="keyword">struct </span>root {</div>
<div class="line">        mutex pmutex;</div>
<div class="line">        shared_mutex shared_pmutex;</div>
<div class="line">        p&lt;int&gt; count;</div>
<div class="line">        persistent_ptr&lt;root&gt; another_root;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* create a pmemobj pool */</span></div>
<div class="line">    <span class="keyword">auto</span> pop = <a class="code" href="classpmem_1_1obj_1_1pool.html#a8c7a780cfb3bc6c708856783938a9e8c">pool&lt;root&gt;::create</a>(<span class="stringliteral">&quot;poolfile&quot;</span>, <span class="stringliteral">&quot;layout&quot;</span>, PMEMOBJ_MIN_POOL);</div>
<div class="line">    <span class="keyword">auto</span> proot = pop.root();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* typical usage schemes */</span></div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="comment">/* take locks and start a transaction */</span></div>
<div class="line">        <a class="code" href="classpmem_1_1obj_1_1basic__transaction.html#a9564707de1779ca1bce7041fb7c9855c">transaction::run</a>(</div>
<div class="line">            pop,</div>
<div class="line">            [&amp;]() {</div>
<div class="line">                <span class="comment">/* atomically allocate objects */</span></div>
<div class="line">                proot-&gt;another_root = make_persistent&lt;root&gt;();</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* atomically modify objects */</span></div>
<div class="line">                proot-&gt;count++;</div>
<div class="line">            },</div>
<div class="line">            proot-&gt;pmutex, proot-&gt;shared_pmutex);</div>
<div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classpmem_1_1transaction__error.html">pmem::transaction_error</a> &amp;) {</div>
<div class="line">        <span class="comment">/* a transaction error occurred, transaction got aborted</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    } <span class="keywordflow">catch</span> (...) {</div>
<div class="line">        <span class="comment">/* some other exception got propagated from within the tx</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclasspmem_1_1obj_1_1basic__transaction_html_a9564707de1779ca1bce7041fb7c9855c"><div class="ttname"><a href="classpmem_1_1obj_1_1basic__transaction.html#a9564707de1779ca1bce7041fb7c9855c">pmem::obj::basic_transaction::run</a></div><div class="ttdeci">static void run(obj::pool_base &amp;pool, std::function&lt; void()&gt; tx, Locks &amp;... locks)</div><div class="ttdoc">Execute a closure-like transaction and lock locks.</div><div class="ttdef"><b>Definition:</b> transaction.hpp:694</div></div>
<div class="ttc" id="aclasspmem_1_1obj_1_1pool_html_a8c7a780cfb3bc6c708856783938a9e8c"><div class="ttname"><a href="classpmem_1_1obj_1_1pool.html#a8c7a780cfb3bc6c708856783938a9e8c">pmem::obj::pool::create</a></div><div class="ttdeci">static pool&lt; T &gt; create(const std::string &amp;path, const std::string &amp;layout, std::size_t size=PMEMOBJ_MIN_POOL, mode_t mode=DEFAULT_MODE)</div><div class="ttdoc">Creates a new transactional object store pool.</div><div class="ttdef"><b>Definition:</b> pool.hpp:694</div></div>
<div class="ttc" id="aclasspmem_1_1transaction__error_html"><div class="ttname"><a href="classpmem_1_1transaction__error.html">pmem::transaction_error</a></div><div class="ttdoc">Custom transaction error class.</div><div class="ttdef"><b>Definition:</b> pexceptions.hpp:81</div></div>
<div class="ttc" id="amake__persistent_8hpp_html"><div class="ttname"><a href="make__persistent_8hpp.html">make_persistent.hpp</a></div><div class="ttdoc">Persistent_ptr transactional allocation functions for objects.</div></div>
<div class="ttc" id="amutex_8hpp_html"><div class="ttname"><a href="mutex_8hpp.html">mutex.hpp</a></div><div class="ttdoc">Pmem-resident mutex.</div></div>
<div class="ttc" id="anamespacepmem_1_1obj_html"><div class="ttname"><a href="namespacepmem_1_1obj.html">pmem::obj</a></div><div class="ttdoc">Main libpmemobj namespace.</div><div class="ttdef"><b>Definition:</b> allocation_flag.hpp:18</div></div>
<div class="ttc" id="apersistent__ptr_8hpp_html"><div class="ttname"><a href="persistent__ptr_8hpp.html">persistent_ptr.hpp</a></div><div class="ttdoc">Persistent smart pointer.</div></div>
<div class="ttc" id="apext_8hpp_html"><div class="ttname"><a href="pext_8hpp.html">pext.hpp</a></div><div class="ttdoc">Convenience extensions for the resides on pmem property template.</div></div>
<div class="ttc" id="apool_8hpp_html"><div class="ttname"><a href="pool_8hpp.html">pool.hpp</a></div><div class="ttdoc">C++ pmemobj pool.</div></div>
<div class="ttc" id="ashared__mutex_8hpp_html"><div class="ttname"><a href="shared__mutex_8hpp.html">shared_mutex.hpp</a></div><div class="ttdoc">Pmem-resident shared mutex.</div></div>
<div class="ttc" id="atransaction_8hpp_html"><div class="ttname"><a href="transaction_8hpp.html">transaction.hpp</a></div><div class="ttdoc">C++ pmemobj transactions.</div></div>
</div><!-- fragment --></div><h2 class="groupheader">Member Typedef Documentation</h2>
<a id="a8ffae81b74ffe313eb2deb16573d70e1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ffae81b74ffe313eb2deb16573d70e1">&#9670;&nbsp;</a></span>automatic</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">pmem::obj::basic_transaction::automatic</a> =  typename <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">detail::transaction_base</a>&lt;false&gt;::<a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">automatic</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>C++ automatic scope transaction class. </p>
<p>This class is one of pmemobj transaction handlers. All operations between creating and destroying the transaction object are treated as performed in a transaction block and can be rolled back. If you have a C++17 compliant compiler, the automatic transaction will commit and abort automatically depending on the context of object destruction.</p>
<p>The locks are held for the entire duration of the transaction. They are released at the end of the scope, so within the <code>catch</code> block, they are already unlocked. If the cleanup action requires access to data within a critical section, the locks have to be manually acquired once again.</p>
<p>The typical usage example would be: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="make__persistent_8hpp.html">libpmemobj++/make_persistent.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mutex_8hpp.html">libpmemobj++/mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="persistent__ptr_8hpp.html">libpmemobj++/persistent_ptr.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pext_8hpp.html">libpmemobj++/pext.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pool_8hpp.html">libpmemobj++/pool.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="shared__mutex_8hpp.html">libpmemobj++/shared_mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="transaction_8hpp.html">libpmemobj++/transaction.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacepmem_1_1obj.html">pmem::obj</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">automatic_tx_example()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* pool root structure */</span></div>
<div class="line">    <span class="keyword">struct </span>root {</div>
<div class="line">        mutex pmutex;</div>
<div class="line">        shared_mutex shared_pmutex;</div>
<div class="line">        p&lt;int&gt; count;</div>
<div class="line">        persistent_ptr&lt;root&gt; another_root;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* create a pmemobj pool */</span></div>
<div class="line">    <span class="keyword">auto</span> pop = <a class="code" href="classpmem_1_1obj_1_1pool.html#a8c7a780cfb3bc6c708856783938a9e8c">pool&lt;root&gt;::create</a>(<span class="stringliteral">&quot;poolfile&quot;</span>, <span class="stringliteral">&quot;layout&quot;</span>, PMEMOBJ_MIN_POOL);</div>
<div class="line">    <span class="keyword">auto</span> proot = pop.root();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <a class="code" href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">transaction::automatic</a> tx(pop, proot-&gt;pmutex,</div>
<div class="line">                      proot-&gt;shared_pmutex);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* atomically allocate objects */</span></div>
<div class="line">        proot-&gt;another_root = make_persistent&lt;root&gt;();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* atomically modify objects */</span></div>
<div class="line">        proot-&gt;count++;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* manual transaction commit is no longer necessary */</span></div>
<div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classpmem_1_1transaction__error.html">pmem::transaction_error</a> &amp;) {</div>
<div class="line">        <span class="comment">/* an internal transaction error occurred, tx aborted</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    } <span class="keywordflow">catch</span> (...) {</div>
<div class="line">        <span class="comment">/* some other exception thrown, tx aborted</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* In complex cases with library calls, remember to check the status of</span></div>
<div class="line"><span class="comment">     * the previous transaction. */</span></div>
<div class="line">    <span class="keywordflow">return</span> transaction::error();</div>
<div class="line">}</div>
<div class="ttc" id="aclasspmem_1_1obj_1_1basic__transaction_html_a8ffae81b74ffe313eb2deb16573d70e1"><div class="ttname"><a href="classpmem_1_1obj_1_1basic__transaction.html#a8ffae81b74ffe313eb2deb16573d70e1">pmem::obj::basic_transaction::automatic</a></div><div class="ttdeci">typename detail::transaction_base&lt; false &gt;::automatic automatic</div><div class="ttdoc">C++ automatic scope transaction class.</div><div class="ttdef"><b>Definition:</b> transaction.hpp:659</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad86b8b9def7073307927ba6e41d0fbf5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad86b8b9def7073307927ba6e41d0fbf5">&#9670;&nbsp;</a></span>manual</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">pmem::obj::basic_transaction::manual</a> =  typename <a class="el" href="classpmem_1_1detail_1_1transaction__base.html">detail::transaction_base</a>&lt;false&gt;::<a class="el" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">manual</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>C++ manual scope transaction class. </p>
<p>This class is one of pmemobj transaction handlers. All operations between creating and destroying the transaction object are treated as performed in a transaction block and can be rolled back. The manual transaction has to be committed explicitly otherwise it will abort.</p>
<p>The locks are held for the entire duration of the transaction. They are released at the end of the scope, so within the <code>catch</code> block, they are already unlocked. If the cleanup action requires access to data within a critical section, the locks have to be manually acquired once again.</p>
<p>The typical usage example would be: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="make__persistent_8hpp.html">libpmemobj++/make_persistent.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mutex_8hpp.html">libpmemobj++/mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="persistent__ptr_8hpp.html">libpmemobj++/persistent_ptr.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pext_8hpp.html">libpmemobj++/pext.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pool_8hpp.html">libpmemobj++/pool.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="shared__mutex_8hpp.html">libpmemobj++/shared_mutex.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="transaction_8hpp.html">libpmemobj++/transaction.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacepmem_1_1obj.html">pmem::obj</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">manual_tx_example()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* pool root structure */</span></div>
<div class="line">    <span class="keyword">struct </span>root {</div>
<div class="line">        mutex pmutex;</div>
<div class="line">        shared_mutex shared_pmutex;</div>
<div class="line">        p&lt;int&gt; count;</div>
<div class="line">        persistent_ptr&lt;root&gt; another_root;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* create a pmemobj pool */</span></div>
<div class="line">    <span class="keyword">auto</span> pop = <a class="code" href="classpmem_1_1obj_1_1pool.html#a8c7a780cfb3bc6c708856783938a9e8c">pool&lt;root&gt;::create</a>(<span class="stringliteral">&quot;poolfile&quot;</span>, <span class="stringliteral">&quot;layout&quot;</span>, PMEMOBJ_MIN_POOL);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> proot = pop.root();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <a class="code" href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">transaction::manual</a> tx(pop, proot-&gt;pmutex,</div>
<div class="line">                       proot-&gt;shared_pmutex);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* atomically allocate objects */</span></div>
<div class="line">        proot-&gt;another_root = make_persistent&lt;root&gt;();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* atomically modify objects */</span></div>
<div class="line">        proot-&gt;count++;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* It&#39;s necessary to commit the transaction manually and</span></div>
<div class="line"><span class="comment">         * it has to be the last operation in the transaction. */</span></div>
<div class="line">        <a class="code" href="classpmem_1_1detail_1_1transaction__base.html#a16c0d86f943d6727e1caa7573cc83edb">transaction::commit</a>();</div>
<div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classpmem_1_1transaction__error.html">pmem::transaction_error</a> &amp;) {</div>
<div class="line">        <span class="comment">/* an internal transaction error occurred, tx aborted</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    } <span class="keywordflow">catch</span> (...) {</div>
<div class="line">        <span class="comment">/* some other exception thrown, tx aborted</span></div>
<div class="line"><span class="comment">         * reacquire locks if necessary */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* In complex cases with library calls, remember to check the status of</span></div>
<div class="line"><span class="comment">     * the previous transaction. */</span></div>
<div class="line">    <span class="keywordflow">return</span> transaction::error();</div>
<div class="line">}</div>
<div class="ttc" id="aclasspmem_1_1detail_1_1transaction__base_html_a16c0d86f943d6727e1caa7573cc83edb"><div class="ttname"><a href="classpmem_1_1detail_1_1transaction__base.html#a16c0d86f943d6727e1caa7573cc83edb">pmem::detail::transaction_base&lt; false &gt;::commit</a></div><div class="ttdeci">static void commit()</div><div class="ttdoc">Manually commit a transaction.</div><div class="ttdef"><b>Definition:</b> transaction.hpp:325</div></div>
<div class="ttc" id="aclasspmem_1_1obj_1_1basic__transaction_html_ad86b8b9def7073307927ba6e41d0fbf5"><div class="ttname"><a href="classpmem_1_1obj_1_1basic__transaction.html#ad86b8b9def7073307927ba6e41d0fbf5">pmem::obj::basic_transaction::manual</a></div><div class="ttdeci">typename detail::transaction_base&lt; false &gt;::manual manual</div><div class="ttdoc">C++ manual scope transaction class.</div><div class="ttdef"><b>Definition:</b> transaction.hpp:633</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a9564707de1779ca1bce7041fb7c9855c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9564707de1779ca1bce7041fb7c9855c">&#9670;&nbsp;</a></span>run()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename... Locks&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void pmem::obj::basic_transaction::run </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classpmem_1_1obj_1_1pool__base.html">obj::pool_base</a> &amp;&#160;</td>
          <td class="paramname"><em>pool</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::function&lt; void()&gt;&#160;</td>
          <td class="paramname"><em>tx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Locks &amp;...&#160;</td>
          <td class="paramname"><em>locks</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Execute a closure-like transaction and lock <code>locks</code>. </p>
<p>The locks have to be persistent memory resident locks. An attempt to lock the locks will be made. If any of the specified locks is already locked, the method will block. The locks are held until the end of the transaction. The transaction does not have to be committed manually. Manual aborts will end the transaction with an active exception.</p>
<p>If an exception is thrown within the transaction, it gets aborted and the exception is rethrown. Therefore extra care has to be taken with proper error handling.</p>
<p>The locks are held for the entire duration of the transaction. They are released at the end of the scope, so within the <code>catch</code> block, they are already unlocked. If the cleanup action requires access to data within a critical section, the locks have to be manually acquired once again.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pool</td><td>the pool in which the transaction will take place. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tx</td><td>an std::function&lt;void ()&gt; which will perform operations within this transaction. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">locks</td><td>locks to be taken for the duration of the transaction.</td></tr>
  </table>
  </dd>
</dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname"><a class="el" href="classpmem_1_1transaction__error.html" title="Custom transaction error class.">transaction_error</a></td><td>on any error pertaining the execution of the transaction. </td></tr>
    <tr><td class="paramname"><a class="el" href="classpmem_1_1manual__tx__abort.html" title="Custom transaction error class.">manual_tx_abort</a></td><td>on manual transaction abort. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>libpmemobj++/<a class="el" href="transaction_8hpp_source.html">transaction.hpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
